---
import BaseLayout from "@layouts/BaseLayout.astro";
// import { Image } from 'astro:assets'
// const images = await Astro.glob("@images/banners/*").then(files => {
//   return files.map(file => file.default.src);
// });

// console.log(images);
---

<BaseLayout
    title="搜索"
    description="搜索本站文章">

    <section class="mx-auto max-w-[85rem] px-4 py-8 sm:px-6 lg:px-8 mb-10 2xl:max-w-full">
      <!-- 搜索框 -->
      <div class="relative">
        <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
          <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
        </div>
        <input type="text" id="searchBox" aria-describedby="floating_helper_text" class="ps-10 block rounded-t-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 dark:bg-gray-700 border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " />
        <label for="searchBox" class="ps-10 absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] start-2.5 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto">Search what you think</label>
      </div>
      <p id="floating_helper_text" class="mt-2 text-xs text-gray-500 dark:text-gray-400">按文章标题模糊查询 <a href="#" class="text-blue-600 dark:text-blue-500">搜你所想</a>😍</p>

      <!-- 结果集 -->
      <div id="results" class="mt-12 grid grid-cols-[repeat(auto-fit,minmax(375px,1fr))] gap-8 justify-items-center"></div>

    </section>
   
</BaseLayout>


<script>
  import { type CollectionEntry, getCollection } from 'astro:content'
  import { Image } from 'astro:assets'

  // import { formatDate } from '../support/time'
  interface resultInterface {
    title: string,
    slug: string,
    description?: string,
    tags: Array<string>,
    data: {
      title: string,
      pubDate: Date,
      category: string,
      description: string,
      author: string,
      cardImage: {src: string, alt: string},
      imageShow: {src: string, alt: string}
      tags: Array<string>
    }
  }
  import Fuse, { type FuseResult } from 'fuse.js';

  function formatDate(date: Date): string {
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')

    return `${year}/${month}/${day}`
}

import { getImage } from 'astro:assets'

  async function search() {
    const options = {
      // isCaseSensitive: false,
      // includeScore: false,
      // shouldSort: true,
      // includeMatches: false,
      // findAllMatches: false,
      // minMatchCharLength: 1,
      // location: 0,
      // threshold: 0.6,
      // distance: 100,
      // useExtendedSearch: false,
      ignoreLocation: true,
      // ignoreFieldNorm: false,
      // fieldNormWeight: 1,
      keys: ["data.title"]
    };
  
    const posts = await getCollection('posts')
    // const posts = await fetch(`${baseSite}/search.json`).then(resp => resp.json());
    console.log(posts);
    posts.map(async post => {
      const imageShow = await getImage({ src: post.data.cardImage,width:post.data.cardImage.width,height:post.data.cardImage.height,format:post.data.cardImage.format })
      post.data.imageShow = imageShow
    })
    const fuse = new Fuse(posts, options);
    const inputBox = document.querySelector<HTMLInputElement>('#searchBox');
      if (inputBox) {
      inputBox.addEventListener('input', () => {    
        const pattern = inputBox.value;
        console.log(pattern);
        const results:FuseResult<resultInterface>[] = fuse.search(pattern);
        console.log(results);
        let html = "";
        for (const result of results) {
          // const appleTouchIcon = getImage({ src: result.item.data.cardImage.src})
          // console.log(appleTouchIcon);
          html += (`
          <div class="bg-white py-10 sm:py-18 rounded-lg shadow-lg dark:bg-neutral-700/60 dark:text-neutral-100 hover:shadow-lg"> 
            <div style="cursor: pointer;" name="mainCard" myurl="/posts/${result.item.slug}" class="mx-auto max-w-5xl px-4 lg:px-6"> 
              <div class="flex items-center gap-x-3 text-xs mb-4">
                <time datetime="2020-03-16" class="text-gray-500">⏰${formatDate(result.item.data.pubDate)}</time>
                <span class="hover:bg-orange-500 hover:text-white dark:hover:text-white dark:hover:bg-orange-500 inline-flex items-center gap-x-1.5 rounded-full bg-neutral-200 px-2 py-1.5 text-xs font-medium text-neutral-700 outline-none focus:outline-none focus-visible:outline-none focus-visible:ring dark:bg-neutral-700/60 dark:text-neutral-300">
                    <a href="/categories/${result.item.data.category}" >🏷️${result.item.data.category}</a>
                </span>
                </div>
                <div class="mx-auto max-w-2xl lg:mx-0">
                  <a href="/posts/${result.item.slug}" class="group dark:text-neutral-300 hover:text-orange-500 dark:hover:text-orange-500 text-1xl font-bold tracking-tight text-gray-900 sm:text-2xl">
                    <div class="flex items-center">
                        <Image
                            class="w-8 h-8 rounded-full me-2 start-0 top-0 size-full object-cover transition duration-600 group-hover:scale-125"
                            src=${result.item.data.imageShow.src}
                            alt=${result.item.data.title}
                            draggable="false"
                            format="avif"
                            loading="eager"
                        />
                        <h5>${result.item.data.title}</h5>
                    </div>
                    <p class="mt-2 text-lg leading-8 text-gray-600 dark:text-neutral-400">${result.item.data.description}</p>
                  </a>
                </div>
              </div>
          </div>
          `);
        }

        const res = document.querySelector('#results')
        if (res)
          res.innerHTML = html; // 更新结果
        
        // 监听页面切换事件
        document.addEventListener('astro:after-swap', search);

        // 监听卡片点击事件
        const mainCards = document.getElementsByName('mainCard')
        mainCards.forEach(function (element) {
          element.addEventListener('click', function (e) {
            const myurl = element?.getAttribute('myurl')
            window.location.href = myurl as string;
          });
        });
        
      })
    }
  }
  search();

  

</script>